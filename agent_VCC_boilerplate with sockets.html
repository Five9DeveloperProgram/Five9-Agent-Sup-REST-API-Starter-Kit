<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="description"
        content="Boilerplate and high-level howto guide with starter examples to use the Five9 VCC Agent and Supervisor REST API" />

    <title>Five9 VCC Agent and Supervisor REST API Wrappers</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous" />
</head>

<body>
    <main class="container">
        <div class="row">
            <div class="col-md-3 col-lg-2"></div>
            <div class="col-md-9 col-lg-10">
                <h1>Greeting</h1>
                <p>do your thing</p>
            </div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-b5kHyXgcpbZJO/tY9Ul7kGkf1S0CWuKcCD38l8YkeH8z8QjE0GmW1gYU5S9FOnJ0" crossorigin="anonymous">
    </script>

    <script type="text/javascript">
        class f9socketEvent {
            constructor(eventName, handler, session) {
                this.eventName = eventName;
                this.handle = handler;
                this.session = session;
            }
        }

        /**
         * The constructor function for the Five9Session class.
         *
         * @class
         * @classdesc Represents a Five9 session with various helper methods for interacting with the Five9 API.
         */
        class Five9Session {
            /**
             * Creates a new Five9Session instance with default properties.
             */
            constructor() {
                // Set the Freedom Metadata URL
                this.freedomMetadataURL = "https://app.five9.com/appsvcs/rs/svc/auth/metadata";

                // Generate a random socket key
                this.randomSocketKey = (Math.random() * 1000 + 1).toString().split(".")[0];

                // Set the context paths for various API endpoints
                this.contextPaths = {
                    agent_rest: "/appsvcs/rs/svc",
                    agent_str: "/strsvcs/rs/svc",
                    sup_rest: "/supsvcs/rs/svc",
                    websocket_agent: `/appsvcs/ws/${this.randomSocketKey}_agent`,
                    websocket_super: `/supsvcs/ws/${this.randomSocketKey}_super`,
                };

                // Set the default XHR options
                this.defaultXhrOptions = {
                    credentials: "include",
                    headers: {
                        "Content-Type": "application/json",
                    },
                };

                // placeholder for updated metadata if provided by a websocket event
                this.newMetadata = null;

                // Initialize instance variables
                this.f9currentCall = null;
                this.f9currentCallId = null;
                this.f9domainContactFieldIdsByFieldName = {};
                this.DOMAIN_CAVs = {};
                this.CAVs = {};

                this.commonSocketEventHanders = {
                    1002: new f9socketEvent(
                        "EVENT_METADATA_UPDATE",
                        function (eventData) {
                            console.log(this.eventName, eventData.context.eventReason);
                            console.log(eventData);
                            this.session.newMetadata = eventData.payLoad;
                        },
                        this
                    ),
                    73: new f9socketEvent(
                        "EVENT_MIGRATION_COMPLETE",
                        async function (eventData) {
                            console.log(this.eventName, eventData.context.eventReason);
                            console.log(eventData);
                            if (this.session.newMetadata) {
                                await this.session.reinitializeWebSocket(this.session.newMetadata);
                            }
                        },
                        this
                    ),
                };
            }

            /**
             * Rebuilds the WebSocket connection using the new metadata provided by the EVENT_METADATA_UPDATE event.
             *
             * @returns {Promise} A Promise that resolves with the Freedom Metadata for the current user.
             */
            async reinitializeWebSocket(newMetadata) {
                // Update instance properties using the new metadata
                const host = newMetadata.dataCenters[0].apiUrls[0].host;
                const port = newMetadata.dataCenters[0].apiUrls[0].port;
                this.base_api_url = `https://${host}:${port}`;
                this.base_ws_url = `wss://${host}:${port}`;

                this.base_api_url_agents = `${this.base_api_url}${this.contextPaths.agent_rest}`;
                this.base_api_url_sprvsr = `${this.base_api_url}${this.contextPaths.sup_rest}`;

                this.base_websocket_api_url_agent = `${this.base_ws_url}${this.contextPaths.websocket_agent}`;
                this.base_websocket_api_url_supervisor = `${this.base_ws_url}${this.contextPaths.websocket_super}`;

                // Reconnect the WebSocket
                await this.connectAgentWebsocket();
            }

            /**
             * Connect to a WebSocket endpoint and process events using provided event handlers.
             *
             * @param {string} endpointUrl - The URL of the WebSocket endpoint to connect to.
             * @param {Object} f9socketEventHandlers - An object containing event handlers for different event IDs.
             */
            async connectSocket(endpointUrl, f9socketEventHandlers) {
                // Create a new WebSocket instance with the provided endpoint URL
                const f9Socket = new window.WebSocket(endpointUrl);
                let pingIntervalHandle = null;

                // Set up the 'onopen' event handler for the WebSocket
                f9Socket.onopen = function () {
                    // Keep the socket connection alive by sending a 'ping' message every 15 seconds
                    pingIntervalHandle = window.setInterval(function () {
                        f9Socket.send("ping");
                    }, 15000);
                    console.info("Websocket Opened");
                };

                // Attach a callback function to the "message" events on the socket
                f9Socket.addEventListener("message", function (event) {
                    // Parse the event data received from the WebSocket message
                    const eventData = JSON.parse(event.data);

                    // Log the event data if the "verbose=true" query parameter is present
                    if (window.location.search.indexOf("verbose=true") > -1) {
                        console.log(eventData.context.eventId + ": " + eventData.context.eventReason);
                        console.log(eventData);
                    }

                    // Retrieve the event handler for the specific event ID
                    let eventHandler = f9socketEventHandlers[eventData.context.eventId];
                    if (eventHandler) {
                        // Call the event handler with the event data
                        eventHandler.handle(eventData);
                    } else {
                        // Register a new 'Unhandled Socket Event' handler if no handler exists for the event ID
                        console.log(`Unhandled Socket Event Registered:\n\t${eventData.context.eventId}\n\t${JSON.stringify(eventData.payLoad)}`);
                        f9socketEventHandlers[eventData.context.eventId] = new f9socketEvent("Unhandled Socket Event", function (eventData) {
                            // console.log(this.eventName, eventData.context.eventReason)
                        });
                    }
                    console.log(eventData);
                });

                // Set up the 'onclose' event handler for the WebSocket
                f9Socket.onclose = function () {
                    // Clear the ping interval when the WebSocket connection is closed
                    window.clearInterval(pingIntervalHandle);
                };

                // Add an event listener for the 'unload' event to close the WebSocket connection when the page is unloaded
                window.addEventListener("unload", function () {
                    f9Socket.close();
                });
                return f9Socket;
            }

            /**
             * Connect to the agent WebSocket endpoint and process events using provided event handlers.
             *
             * @param {Object} f9socketEventHandlers - An object containing event handlers for different event IDs.
             */
            async connectAgentWebsocket(f9socketEventHandlers = {}) {
                // merge the common socket event handlers with the agent specific ones
                f9socketEventHandlers = Object.assign(f9socketEventHandlers, this.commonSocketEventHanders);

                return this.connectSocket(this.base_websocket_api_url_agent, f9socketEventHandlers);
            }

            /**
             * A generic asynchronous method for making API requests to the agent and supervisor REST API.
             *
             * @async
             * @function
             * @param {string} endpointURL - The URL of the API endpoint.
             * @param {string} method - The HTTP request method (e.g., "GET", "POST", "PUT", "DELETE").
             * @param {Object} [endpointOptions] - Optional configuration object for the request, such as headers.
             * @param {Object|string} [payload] - Optional request payload, if applicable.
             * @param {bool} bypassSupervisorCheck - Optional, bypass the supervisor check for supervisor methods that do not need a check.
             * @returns {Promise<Object|null>} Returns a Promise that resolves to the JSON response object or null if there was an error.
             * @throws {Error} If the response is not ok.
             */
            async f9ApiMethod(
                endpointURL,
                method,
                payload = undefined,
                endpointOptions = undefined,
                bypassSupervisorCheck = false
            ) {
                // Set default options if endpointOptions is not provided
                if (!endpointOptions) {
                    endpointOptions = { ...this.defaultXhrOptions };
                }

                // Set the request method in endpointOptions
                endpointOptions.method = method;

                // Add the payload to the request options, if provided
                if (payload) {
                    endpointOptions.body = payload;
                    // Convert the payload to a JSON string if it's an object and the Content-Type is "application/json"
                    if (
                        endpointOptions.headers["Content-Type"] == "application/json" &&
                        typeof payload == "object"
                    ) {
                        endpointOptions.body = JSON.stringify(endpointOptions.body);
                    }
                }

                try {
                    // Log the endpoint URL
                    console.log(`Endpoint URL: ${endpointURL}`);

                    // Make the request and wait for the response
                    const response = await fetch(endpointURL, endpointOptions);

                    // Throw an error if the response is not ok
                    if (!response.ok) {
                        throw new Error(`Error fetching ${endpointURL}`);
                    }

                    // Parse the response JSON
                    try {
                        const data = await response.json();
                        // Log the response data
                        console.log(`Endpoint Response Body:`);
                        console.log(data);

                        // Return the response data
                        return data;
                    } catch (error) {
                        return response;
                    }
                } catch (error) {
                    // Log the error and return null
                    console.error(error);
                    return null;
                }
            }

            /**
             * Fetch session metadata and initialize the instance properties.
             *
             * This method should be the first thing called after initializing the Five9Session object.
             * It fetches session metadata from the Five9 API, extracts the necessary data,
             * and initializes the instance properties accordingly.
             *
             * @async
             * @function
             * @returns {Promise<boolean>} Returns a Promise that resolves to true if the metadata is successfully acquired, and false otherwise.
             */
            async getSessionMetadata() {
                try {
                    // Fetch the session metadata from the Five9 API
                    const response = await fetch(this.freedomMetadataURL, {
                        credentials: "include",
                    });
                    if (!response.ok) {
                        throw new Error("Error fetching session metadata");
                    }

                    // Parse the response as JSON
                    const metadataResponse = await response.json();

                    // Set instance properties using the fetched metadata
                    this.f9OrgId = metadataResponse.orgId;
                    this.f9UserId = metadataResponse.userId;
                    this.f9TokenId = metadataResponse.tokenId;

                    const host = metadataResponse.metadata.dataCenters[0].apiUrls[0].host;
                    const port = metadataResponse.metadata.dataCenters[0].apiUrls[0].port;
                    this.base_api_url = `https://${host}:${port}`;
                    this.base_ws_url = `wss://${host}:${port}`;

                    this.base_api_url_agents = `${this.base_api_url}${this.contextPaths.agent_rest}`;
                    this.base_api_url_sprvsr = `${this.base_api_url}${this.contextPaths.sup_rest}`;

                    this.base_websocket_api_url_agent = `${this.base_ws_url}${this.contextPaths.websocket_agent}`;
                    this.base_websocket_api_url_supervisor = `${this.base_ws_url}${this.contextPaths.websocket_super}`;

                    // Log the successful acquisition of metadata
                    console.log(`Metadata successfully acquired\norgId: \t${this.f9OrgId}\nuserId: \t${this.f9UserId}\ntokenId: \t${this.f9TokenId}`);

                    // Return true to indicate successful metadata acquisition
                    return true;
                } catch (error) {
                    // Log an error message and return false to indicate failure
                    console.log("You must be logged into Five9 in another browser tab for this to work");
                    return false;
                }
            }

            /**
             * getCampaignInfo returns a CampaignInfo object, requires a campaignId.
             *
             * Five9 VCC Agent API Method:
             *   GET /orgs/{orgId}/campaigns/{campaignId}
             *
             * Five9 Response sample:
             *   {
             *       "id":"2494",
             *       "name":"Inbound Service",
             *       "campaignType":"INBOUND",
             *       "customSource":null,
             *       "customIcon":null,
             *       "assistances":[],
             *       "attributes":[],
             *       "avatarURL":null,
             *       "chatWelcomeMessage":null,
             *       "chatTerminateMessage":null,
             *       "outEmail":null,
             *       "skillIds":[],
             *       "state":"RUNNING",
             *       "flags":["PASS_CONTACTS_ANI_FOR_3RD_PARTY_CONFERENCES"]
             *   }
             *
             * Method return sample:
             *   <object campaignInfo>
             */
            async getCampaignInfo(campaignId) {
                const endpointURL = `${this.base_api_url_agents}/orgs/${this.f9OrgId}/campaigns/${campaignId}`;
                return this.f9ApiMethod(endpointURL, "GET");
            }

        /**
             * getAgentInfo returns agent information for a given userId
             * 
             * Five9 VCC Agent API Method:
             *   GET /agents/{agentId}
             */
            async getAgentInfo(userId = null) {
                const agentId = userId || this.f9UserId;
                const endpointURL = `${this.base_api_url_agents}/agents/${agentId}`;
                return this.f9ApiMethod(endpointURL, "GET");
            }

            /**
             * getAgentCampaigns returns a dictionary of campaignInfo objects the agent skills give them access to, with the campaign name as the key.
             *
             * Five9 VCC Agent API Method:
             *   GET /agents/{agentId}/campaigns_config
             *
             * Five9 Response sample:
             * ["1234", "43802", "23423"]
             *
             * method return sample:
             * {"Inbound Service": <object campaignInfo>, "Outbound Outreach": <object campaignInfo>}
             */
            async getAgentCampaigns() {
                const endpointURL = `${this.base_api_url_agents}/agents/${this.f9UserId}/campaigns_config`;
                console.log(endpointURL);
                
                const response = await this.f9ApiMethod(endpointURL, "GET");
                if (response && response.campaignIds) {
                    const agentCampaignsInfo = {};
                    
                    // Use Promise.all to get all campaign info in parallel
                    const campaignPromises = response.campaignIds.map(campaignId => 
                        this.getCampaignInfo(campaignId)
                    );
                    
                    const campaigns = await Promise.all(campaignPromises);
                    campaigns.forEach(campaign => {
                        if (campaign && campaign.name) {
                            agentCampaignsInfo[campaign.name] = campaign;
                        }
                    });
                    
                    return agentCampaignsInfo;
                }
                return response;
            }

            /**
             * callExternalNumber initiates an outbound call to a dnis and requires EITHER a campaignName OR campaignId which will be used to make the call
             *
             * Five9 VCC Agent API Method:
             *   POST /agents/{agentId}/interactions/make_external_call
             *
             * Five9 Response sample:
             *     undefined
             *     (status 200 OK)
             */
            async callExternalNumber(dnis, campaignName = null, campaignId = null) {
                if (campaignId == null && campaignName == null) {
                    console.log("callExternalNumber() requires a campaignName or campaignId");
                    return null;
                }

                const ExternalCallDestinationInfo = {
                    number: dnis,
                    campaignId: campaignId,
                };

                if (campaignId == null) {
                    const agentCampaigns = await this.getAgentCampaigns();
                    ExternalCallDestinationInfo.campaignId = agentCampaigns[campaignName].id;
                }

                if (ExternalCallDestinationInfo.campaignId == null) {
                    console.log("callExternalNumber() requires a valid campaignName or campaignId. campaignName provided: " + campaignName);
                    return null;
                }

                const endpointURL = `${this.base_api_url_agents}/agents/${this.f9UserId}/interactions/make_external_call`;
                console.log(endpointURL);
                
                return this.f9ApiMethod(endpointURL, "POST", ExternalCallDestinationInfo);
            }

            /**
             * getCurrentCalls returns an array of calls [<object CallInfo>, ] with which the agent can work
             *
             * Five9 VCC Agent API Method:
             *   GET /agents/{agentId}/interactions/calls
             *
             * Five9 Response Sample <object callInfo>:
             *   [{id: "C86EBE50B9744D6D946531842B278846", campaignId: "1137597", callType: "AGENT", transfer: false, userTransferringId: null, ...}, ...]
             */
            async getCurrentCalls() {
                const endpointURL = `${this.base_api_url_agents}/agents/${this.f9UserId}/interactions/calls`;
                console.log(endpointURL);
                const calls = await this.f9ApiMethod(endpointURL, "GET");
                if (calls && calls.length > 0) {
                    this.f9currentCall = calls[0];
                    this.f9currentCallId = calls[0].id;
                }
                return calls;
            }

            /**
             * click2dial initiates a click to dial call
             */
            async click2dial(campaignId) {
                const endpointURL = `${this.base_api_url_agents}/orgs/${this.f9OrgId}/interactions/click_to_dial?number=9133259337&dialImmediately=true&skipDNCCheck=true&campaignId=${campaignId}&autoResolveDialingRules=true&skipMultipleContactsCheck=true`;
                return this.f9ApiMethod(endpointURL, "GET");
            }


            /**
             * getDomainCallVariables returns the call attached variables for a given callID
             *
             * Five9 VCC Agent API Method:
             *   GET /orgs/{orgId}/call_variables
             */
            async getDomainCallVariables() {
                const endpointURL = `${this.base_api_url_agents}/orgs/${this.f9OrgId}/call_variables`;
                console.log(endpointURL);
                
                const cavsResponse = await this.f9ApiMethod(endpointURL, "GET");
                if (cavsResponse) {
                    const cavs = {};
                    cavsResponse.forEach((cav) => {
                        cavs[cav.group] = cavs[cav.group] || {};
                        cavs[cav.group][cav.name] = cavs[cav.group][cav.name] || {};
                        cavs[cav.group][cav.name]["id"] = cav.id;
                        cavs[cav.group][cav.name]["type"] = cav.type;
                        cavs[cav.group][cav.name]["restrictions"] = cav.restrictions;
                    });
                    console.log("Domain CAVs after transformation:");
                    console.log(cavs);
                    this.DOMAIN_CAVs = cavs;
                    return cavs;
                }
                return cavsResponse;
            }

            /**
             * setDomainCallVariable returns the call attached variables for a given callID
             *
             * Five9 VCC Agent API Method:
             *   GET /orgs/{orgId}/call_variables
             */
            async setDomainCallVariable() {
                const endpointURL = `${this.base_api_url_agents}/orgs/${this.f9OrgId}/call_variables`;
                console.log(endpointURL);
                return this.f9ApiMethod(endpointURL, "GET");
            }

            /**
             * getContactFields returns an array of contactFields on the domain
             *
             * Five9 VCC Agent API Method:
             *   GET /orgs/{orgId}/contact_fields
             *
             * Five9 Response Sample <object domainContactFields>:
             *   [{dataType: "NUMBER", id: "114", name: "influence_score", primary: false, restrictions: {restrictions: [], limitedSetInfo: null} }, ...]
             */
            async getContactFields() {
                const endpointURL = `${this.base_api_url_agents}/orgs/${this.f9OrgId}/contact_fields`;
                console.log(endpointURL);

                const contactFields = await this.f9ApiMethod(endpointURL, "GET");
                if (contactFields) {
                    for (const fieldId in contactFields) {
                        this.f9domainContactFieldIdsByFieldName[contactFields[fieldId].name] = contactFields[fieldId];
                    }
                }
                return contactFields;
            }

            /**
             * Updates contact info. Accepts an array of fieldId and Values to update on the record.
             *
             * Five9 VCC Agent API Method:
             *   PUT /agents/{agentId}/interactions/calls/{callId}/update_contact
             */
            async updateContactInfo(fieldUpdates = [{ 1010: "TestFirstName" }]) {
                const contactFields = await this.getContactFields();
                console.log(contactFields);

                const activeCalls = await this.getCurrentCalls();
                const activeCall = activeCalls[0];
                const callId = activeCall.id;
                console.log(activeCall);

                // Process Field Updates
                for (let i = 0; i < fieldUpdates.length; i++) {
                    activeCall.activeContact.fields[fieldUpdates[i]] = "AWTEST87";
                }

                const contactInfo = activeCall.activeContact;
                console.log(contactInfo);
                const endpointURL = `${this.base_api_url_agents}/agents/${this.f9UserId}/interactions/calls/${callId}/update_contact`;

                return this.f9ApiMethod(endpointURL, "PUT", contactInfo);
            }

            /**
             * Updates contact info by field name. Accepts an object of field names and values to update on the record.
             *
             * Five9 VCC Agent API Method:
             *   PUT /orgs/{orgId}/contacts/{contactId}
             */
            async updateContactInfoByFieldName(contact, fieldUpdates) {
                const contactFields = await this.getContactFields();
                
                for (const [key, value] of Object.entries(fieldUpdates)) {
                    console.log("Updating " + key + ": " + value);
                    const fieldId = this.f9domainContactFieldIdsByFieldName[key].id;
                    contact.fields[fieldId] = value;
                }

                const endpointURL = `${this.base_api_url_agents}/orgs/${this.f9OrgId}/contacts/${contact.id}`;
                console.log(endpointURL);

                return this.f9ApiMethod(endpointURL, "PUT", contact);
            }

            /**
             * pauseCurrentCallRecording stops call recording for a given callId. If no callId is provided, the
             * user's active call is obtained from getCurrentCalls()
             *
             * Five9 VCC Agent API Method:
             *   PUT /agents/{agentId}/interactions/calls/{callId}/pause_recording
             */
            async pauseCurrentCallRecording(callId = null) {
                if (callId === null) {
                    const activeCalls = await this.getCurrentCalls();
                    callId = activeCalls[0].id;
                }

                const endpointURL = `${this.base_api_url_agents}/agents/${this.f9UserId}/interactions/calls/${callId}/pause_recording`;
                console.log(endpointURL);

                return this.f9ApiMethod(endpointURL, "PUT");
            }

            /**
             * stopCurrentCallRecording stops call recording for a given callId. If no callId is provided, the
             * user's active call is obtained from getCurrentCalls()
             *
             * Five9 VCC Agent API Method:
             *   PUT /agents/{agentId}/interactions/calls/{callId}/stop_recording
             */
            async stopCurrentCallRecording(callId = null) {
                if (callId === null) {
                    const activeCalls = await this.getCurrentCalls();
                    callId = activeCalls[0].id;
                }

                const endpointURL = `${this.base_api_url_agents}/agents/${this.f9UserId}/interactions/calls/${callId}/stop_recording`;
                console.log(endpointURL);

                return this.f9ApiMethod(endpointURL, "PUT");
            }

            /**
             * dispose Finishes a call and sets a disposition.
             *
             * Five9 VCC Agent API Method:
             *   PUT /agents/{agentId}/interactions/calls/{callId}/dispose
             */
            async disposeCurrentCall(callId = null, dispositionId, timeout = null) {
                if (callId === null) {
                    const activeCalls = await this.getCurrentCalls();
                    callId = activeCalls[0].id;
                }

                const endpointURL = `${this.base_api_url_agents}/agents/${this.f9UserId}/interactions/calls/${callId}/dispose`;
                console.log(endpointURL);
                console.log(callId);
                
                const disposeOptionsInfo = {
                    dispositionId: dispositionId,
                };

                if (timeout != null) {
                    disposeOptionsInfo.timeout = timeout;
                }

                return this.f9ApiMethod(endpointURL, "PUT", disposeOptionsInfo);
            }

            /**
             * resumeCurrentCallRecording resumes call recording for a given callId.
             *
             * Five9 VCC Agent API Method:
             *   PUT /agents/{agentId}/interactions/calls/{callId}/resume_recording
             */
            async resumeCurrentCallRecording(callId = null) {
                if (callId === null) {
                    const activeCalls = await this.getCurrentCalls();
                    callId = activeCalls[0].id;
                }

                const endpointURL = `${this.base_api_url_agents}/agents/${this.f9UserId}/interactions/calls/${callId}/resume_recording`;
                console.log(endpointURL);

                return this.f9ApiMethod(endpointURL, "PUT");
            }

            /**
             * initiateConferenceTransfer adds a DNIS to the call. Set warm=true for a warm conference (1st party on hold).
             *
             * Five9 VCC Agent API Method:
             *   POST /agents/{agentId}/interactions/calls/{callId}/add_external_to_conference
             */
            async initiateConferenceTransfer(callId, dnis, warm = false, checkDNC = true, includeCallerInfo = true) {
                const destinationInfo = {
                    number: dnis,
                    warm: warm,
                    checkDNC: checkDNC,
                    includeCallerInfo: includeCallerInfo,
                };

                const endpointURL = `${this.base_api_url_agents}/agents/${this.f9UserId}/interactions/calls/${callId}/add_external_to_conference`;
                console.log(endpointURL);

                return this.f9ApiMethod(endpointURL, "POST", destinationInfo);
            }

            /**
             * initiateTransferToExternal transfers the call to an external number. Set warm=true for a warm transfer (1st party on hold).
             *
             * Five9 VCC Agent API Method:
             *   PUT /agents/{agentId}/interactions/calls/{callId}/transfer_to_external_number
             */
            async initiateTransferToExternal(
                dnis,
                dispositionId = "-23",
                dispositionTimeout = 300000,
                timeout = 0,
                warm = false,
                skipDNCCheck = false
            ) {
                const activeCalls = await this.getCurrentCalls();
                const callId = activeCalls[0].id;

                const externalTransferDestinationInfo = {
                    destination: {
                        skipDNCCheck: skipDNCCheck,
                        checkMultipleContacts: true,
                        number: dnis,
                    },
                    warm: warm,
                    dispositionTimeout: dispositionTimeout,
                    timeout: timeout,
                };

                const endpointURL = `${this.base_api_url_agents}/agents/${this.f9UserId}/interactions/calls/${callId}/transfer_to_external_number`;
                console.log(endpointURL);

                return this.f9ApiMethod(endpointURL, "PUT", externalTransferDestinationInfo);
            }

            /**
             * addCampaignToConference adds a campaign to conference. Set warm=true for a warm transfer (1st party on hold).
             *
             * Five9 VCC Agent API Method:
             *   PUT /agents/{agentId}/interactions/calls/{callId}/add_campaign_to_conference
             */
            async addCampaignToConference(campaignId = "1140040", warm = false) {
                const activeCalls = await this.getCurrentCalls();
                const callId = activeCalls[0].id;

                const campaignInfo = {
                    campaignId: campaignId,
                    warm: warm,
                };

                const endpointURL = `${this.base_api_url_agents}/agents/${this.f9UserId}/interactions/calls/${callId}/add_campaign_to_conference`;
                console.log(endpointURL);

                return this.f9ApiMethod(endpointURL, "POST", campaignInfo);
            }

            /**
             * Returns active skills prompts information for the specified agent
             *
             * Five9 VCC Agent API Method:
             *   GET /agents/{agentId}/prompts
             */
            async getPrompts() {
                const endpointURL = `${this.base_api_url_agents}/agents/${this.f9UserId}/prompts`;
                console.log(endpointURL);
                return this.f9ApiMethod(endpointURL, "GET");
            }

            /**
             * Returns speed dials
             *
             * Five9 VCC Agent API Method:
             *   GET /orgs/{orgId}/speed_dials
             */
            async getDomainSpeedDials() {
                const endpointURL = `${this.base_api_url_agents}/orgs/${this.f9OrgId}/speed_dials`;
                console.log(endpointURL);
                return this.f9ApiMethod(endpointURL, "GET");
            }

            /**
             * get EWT for a specific skill
             *
             * Five9 VCC Agent API Method:
             *   GET /orgs/{orgId}/ewt/group/{skillGroupId}/{mediaTypeId}
             */
            async getEwtForSkill(skillGroupId, mediaTypeId = "3000") {
                const endpointURL = `${this.base_api_url_sprvsr}/orgs/${this.f9OrgId}/ewt/group/${skillGroupId}/${mediaTypeId}`;
                console.log(endpointURL);
                return this.f9ApiMethod(endpointURL, "GET");
            }

            /**
             * play_prompt plays an audio prompt on the agent interaction
             *
             * Five9 VCC Agent API Method:
             *   PUT /agents/{agentId}/interactions/calls/{callId}/audio/player/play_prompt
             */
            async playPrompt(promptId) {
                const activeCalls = await this.getCurrentCalls();
                const callId = activeCalls[0].id;

                const promptInfo = {
                    value: promptId,
                };

                const endpointURL = `${this.base_api_url_agents}/agents/${this.f9UserId}/interactions/calls/${callId}/audio/player/play_prompt`;
                console.log(endpointURL);

                return this.f9ApiMethod(endpointURL, "PUT", promptInfo);
            }

            /**
             * callRecordingView creates a Call Recording View
             *
             * Five9 VCC Agent API Method:
             *   POST /supervisors/{supervisorId}/agents/{agentId}/recording_views
             */
            async callRecordingView(limit = 300, sortField = "NAME", ascending = true, target_agentID = "") {
                const RecordingsViewOptions = {
                    limit: limit,
                    sortField: sortField.toUpperCase(),
                    ascending: "true",
                };

                const endpointURL = `${this.base_api_url_sprvsr}/supervisors/${this.f9UserId}/agents/${target_agentID}/recording_views`;
                console.log(endpointURL);

                return this.f9ApiMethod(endpointURL, "POST", RecordingsViewOptions);
            }

            /**
             * getContactById obtains contact record by ContactId
             *
             * Five9 VCC Agent API Method:
             *   GET /orgs/{orgId}/contacts/{contactId}
             */
            async getContactById(contactId) {
                const endpointURL = `${this.base_api_url_agents}/orgs/${this.f9OrgId}/contacts/${contactId}`;
                console.log("getContactById" + endpointURL);
                return this.f9ApiMethod(endpointURL, "GET");
            }

            /**
             * assignContactToCall assigns a contact record to a call
             *
             * Five9 VCC Agent API Method:
             *   PUT /agents/{agentId}/interactions/calls/{callId}/active_contact_2
             */
            async assignContactToCall(contactId) {
                const currentCalls = await this.getCurrentCalls();
                const callId = currentCalls[0].id;

                const contactInfo = {
                    value: contactId,
                };

                const endpointURL = `${this.base_api_url_agents}/agents/${this.f9UserId}/interactions/calls/${callId}/active_contact_2`;
                console.log(endpointURL);

                return this.f9ApiMethod(endpointURL, "PUT", contactInfo);
            }
        }

        // THIS is where you would build out event handlers for things that you care about
        let f9socketEventHandlers = {
            4: new f9socketEvent("EVENT_CALL_UPDATED", function (eventData) {
                console.log(this.eventName, eventData.context.eventReason);
                console.log(eventData);

                // EXAMPLE use events to stop/start recording for all calls
                // let stopRecordingReasons = ["UPDATED", "CONNECTED", "RECORDING_ALLOWED"];
                // let stopRecordingStates = ["TALKING"];

                //if(stopRecordingReasons.indexOf(eventData.context.eventReason) > -1 && stopRecordingStates.indexOf(eventData.payload.state))
            }),

            5: new f9socketEvent("EVENT_CALL_DELETED", function (eventData) {
                console.log(this.eventName, eventData.context.eventReason);
                console.log(eventData);
            }),
        };

        function onDocumentReady(fn) {
            if (document.readyState !== "loading") {
                fn();
            } else {
                document.addEventListener("DOMContentLoaded", fn);
            }
        }

        onDocumentReady(async function () {
            const session = new Five9Session();
            const metadataObtained = await session.getSessionMetadata();
            
            if (metadataObtained === true) {
                console.info("Session Metadata obtained for user:", session.f9UserId);
                
                // Connect to websocket with custom event handlers
                const agentWebSocket = await session.connectAgentWebsocket(f9socketEventHandlers);
                
                // Get current calls to initialize session state
                const currentCalls = await session.getCurrentCalls();
                console.log("Current calls:", currentCalls);
                
                console.info("Five9 Session initialized successfully");
            } else {
                console.log("You must be logged into Five9 in another browser tab for this to work");
            }
        });
    </script>
</body>

</html>