<!doctype html>
<html>     
    <head>
        <meta charset="utf-8">
        <title>PlayPrompt on Accept</title>

    </head>
    <body>
        <main class="container">
        </main>

        <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js" integrity="sha384-b5kHyXgcpbZJO/tY9Ul7kGkf1S0CWuKcCD38l8YkeH8z8QjE0GmW1gYU5S9FOnJ0" crossorigin="anonymous"></script>                
        
        <script type="text/javascript">
            let freedomMetadataURL = "https://app.five9.com/appsvcs/rs/svc/auth/metadata";
            let five9SessionData;

            /** 
            * API Context Paths:
            *      Agent REST API Services "agent_rest": "/appsvcs/rs/svc",
            *      Agent call recordings and email message attachments "agent_str": "/strsvcs/rs/svc",
            *      Supervisor REST API Services "sup_resut": "/supsvcs/rs/svc"
            *      Websocket connection: "/appsvcs/ws/<socketkey>"
            *           *Note:* The socketkey is optional, but only 3 sockets can exist for a user at any one time.
            *                   Setting a random number here allows this code to be use in both an agent script AND in another browser tab
            *                   The 4th websocket opened will cause the oldest open socket to close.
            */
            let randomSocketKey = (Math.random() * 1000) + 1

            let contextPaths = {
                "agent_rest": "/appsvcs/rs/svc",
                "agent_str": "/strsvcs/rs/svc",
                "sup_rest": "/supsvcs/rs/svc",
                "websocket": "/appsvcs/ws/" + randomSocketKey,
                "supervisor_websocket": "/supsvcs/ws/" + randomSocketKey
            }

            let base_api_url;
            let base_agents_api_url;
            let base_supervisor_api_url;
            let base_websocket_api_url;
            let base_supervisor_websocket_api_url;

            let f9OrgId;
            let f9UserId;

            let f9CurrentCallId;
            let f9CurrentCallCampaignId;

            let DOMAIN_CONTACT_FIELDS_BY_FIELDNAME = {};
            let DOMAIN_CAVs = {};


            /**
            * play_prompt plays an audio prompt on the agent interaction
            * 
            * Five9 VCC Agent API Method:
            *   PUT /agents/{agentId}/interactions/calls/{callId}/audio/player/play_prompt
            * 
            * Five9 Response Sample:
            *   
            */
            function playPrompt(callId, promptId){

                let promptInfo = JSON.stringify({
                    "value": promptId
                });

                let endpointURL = base_agents_api_url+"/agents/"+f9UserId+"/interactions/calls/"+callId+"/audio/player/play_prompt";
                console.log(endpointURL);

                return $.ajax({
                    url: endpointURL,
                    type: 'PUT',
                    data: promptInfo,
                    contentType: "application/json",
                    success: function(res) {
                        console.log("Conference Response")
                        console.log(res);
                    }
                });	
            }


            function getSessionMetadata(){
                return $.get(freedomMetadataURL, function( data ) {
                    five9SessionData = data;
                    f9OrgId = five9SessionData.orgId;
                    f9UserId = five9SessionData.userId;

                    base_api_url = "https://" + five9SessionData.metadata.dataCenters[0].apiUrls[0].host + ":" + five9SessionData.metadata.dataCenters[0].apiUrls[0].port;
                    base_ws_url = "wss://" + five9SessionData.metadata.dataCenters[0].apiUrls[0].host + ":" + five9SessionData.metadata.dataCenters[0].apiUrls[0].port;
                    
                    base_agents_api_url = base_api_url + contextPaths.agent_rest;
                    base_supervisor_api_url = base_api_url + contextPaths.sup_rest;
                    base_websocket_api_url = base_ws_url + contextPaths.websocket;
                    base_supervisor_websocket_api_url = base_ws_url + contextPaths.supervisor_websocket;

                    console.log(("user ID: " + five9SessionData.userId));
                    console.log("Base Supervisor API URL: " + base_supervisor_api_url);
                    console.log("Base Agent API URL: " + base_agents_api_url);
                    // console.log(data);
                }).fail(function (data){
                    console.log("You must be logged into Five9 in another browser tab for this to work");
                    $(".example-links").hide();
                });
            }


            class f9socketEvent {
                constructor(eventName, handler) {
                    this.eventName = eventName
                    this.handle = handler
                }
            }


            let conferenceParticipantCallId;
            // THIS is where to build out event handlers for things that you care about
            let f9socketEventHandlers = {
                "4": new f9socketEvent("EVENT_CALL_UPDATED", function(eventData){
                    console.log(this.eventName, eventData.context.eventReason);
                    console.log(eventData);
                    
                    if(eventData.context.eventReason === "CONNECTED"){
                        console.log("PLAYING PROMPT")
                        playPrompt(eventData.payLoad.id, "222995");
                    }                
                }),
            }

            $( document ).ready(function() {

                // set crossDomain to allow page to run in separate tab and not on a campaign script
                $.ajaxSetup({
                    crossDomain: true,
                    xhrFields: {
                        withCredentials: true
                    }
                });

                // first obtain session metadata, and once that is complete, open a socket
                $.when(getSessionMetadata()).then(function(sessionMetaData){
                    console.info('Session Metadata:', sessionMetaData);

                    const socket = new window.WebSocket(base_websocket_api_url);
                    let pingIntervalHandle = null;

                    socket.onopen = function () {
                        // Socket has to be kept alive with one ping every 15 seconds
                        pingIntervalHandle = window.setInterval(function() {
                            socket.send('ping');
                        }, 15000);
                        console.info('Websocket Opened')
                    };

                    // attach a callback function to the "message" events on the socket
                    socket.addEventListener('message', function(event) {
                        eventData = JSON.parse(event.data);
                        eventHandler = f9socketEventHandlers[eventData.context.eventId];
                        if(eventHandler){
                            eventHandler.handle(eventData);
                        } else {
                            f9socketEventHandlers[eventData.context.eventId] = new f9socketEvent("Unhandled Socket Event", function(eventData){
                                //console.log(this.eventName, eventData.context.eventReason)
                            });
                        }
                        //console.log(eventData);
                    });

                    socket.onclose = function() {
                        window.clearInterval(pingIntervalHandle);
                    }

                    window.addEventListener('unload', function () {
                        socket.close();
                    })                    
                    console.info('Session Metadata:', sessionMetaData);
                });
            });
        </script>
    </body>
</html>