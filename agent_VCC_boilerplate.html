<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description"
        content="Boilerplate and high-level howto guide with starter examples to use the Five9 VCC Agent and Supervisor REST API" />

    <title>Five9 VCC Agent REST API Boilerplate - Sample Interface</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-shadow {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .result-box {
            max-height: 300px;
            overflow-y: auto;
        }
        .pulse-dot {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        /* SweetAlert2 Custom Styling */
        .swal2-popup {
            border-radius: 0.75rem !important;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25) !important;
        }
        .swal2-title {
            font-weight: 600 !important;
            color: #374151 !important;
        }
        .swal2-content {
            color: #6b7280 !important;
        }
        .swal2-confirm {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            border: none !important;
            border-radius: 0.5rem !important;
            padding: 0.75rem 1.5rem !important;
            font-weight: 500 !important;
        }
        .swal2-cancel {
            background: #f3f4f6 !important;
            color: #374151 !important;
            border: none !important;
            border-radius: 0.5rem !important;
            padding: 0.75rem 1.5rem !important;
            font-weight: 500 !important;
        }
        .swal2-input {
            border: 2px solid #e5e7eb !important;
            border-radius: 0.5rem !important;
            padding: 0.75rem !important;
            font-size: 1rem !important;
        }
        .swal2-input:focus {
            border-color: #667eea !important;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1) !important;
        }
    </style>
</head>

<body class="bg-gray-50 font-sans">
    <!-- Header -->
    <header class="gradient-bg text-white shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold">Five9 VCC REST API</h1>
                    <p class="text-blue-100 mt-2">Interface sample with Real-time Events</p>
                </div>
                <div id="connectionStatus" class="flex items-center space-x-2">
                    <div id="statusIndicator" class="w-3 h-3 bg-red-400 rounded-full pulse-dot"></div>
                    <span id="statusText" class="text-sm">Connecting...</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container mx-auto px-4 py-8" x-data="f9Interface()">
        <!-- Session Info Card -->
        <div class="bg-white rounded-lg card-shadow p-6 mb-8">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Session Information</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-blue-50 p-4 rounded-lg">
                    <h3 class="font-medium text-blue-800">User ID</h3>
                    <p id="userIdDisplay" class="text-sm text-gray-600 mt-1">Not connected</p>
                </div>
                <div class="bg-green-50 p-4 rounded-lg">
                    <h3 class="font-medium text-green-800">Organization ID</h3>
                    <p id="orgIdDisplay" class="text-sm text-gray-600 mt-1">Not connected</p>
                </div>
                <div class="bg-purple-50 p-4 rounded-lg">
                    <h3 class="font-medium text-purple-800">WebSocket Events</h3>
                    <p id="eventCount" class="text-sm text-gray-600 mt-1">0 events received</p>
                </div>
            </div>
        </div>

        <!-- API Methods Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Call Management -->
            <div class="bg-white rounded-lg card-shadow p-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-6 flex items-center">
                    <svg class="w-6 h-6 mr-2 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                    </svg>
                    Call Management
                </h3>
                <div class="space-y-3">
                    <button @click="getCurrentCalls()" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                        Get Current Calls
                    </button>
                    <button @click="makeExternalCall()" class="w-full bg-green-500 hover:bg-green-600 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                        Make External Call
                    </button>
                    <button @click="initiateConference()" class="w-full bg-purple-500 hover:bg-purple-600 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                        Conference Transfer
                    </button>
                    <button @click="disposeCall()" class="w-full bg-red-500 hover:bg-red-600 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                        Dispose Current Call
                    </button>
                </div>
            </div>

            <!-- Recording Controls -->
            <div class="bg-white rounded-lg card-shadow p-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-6 flex items-center">
                    <svg class="w-6 h-6 mr-2 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 14.142M6.343 6.343a9 9 0 000 12.728m2.829-9.9a5 5 0 000 7.072M12 12h.01"></path>
                    </svg>
                    Recording Controls
                </h3>
                <div class="space-y-3">
                    <button @click="pauseRecording()" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                        Pause Recording
                    </button>
                    <button @click="resumeRecording()" class="w-full bg-green-500 hover:bg-green-600 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                        Resume Recording
                    </button>
                    <button @click="stopRecording()" class="w-full bg-red-500 hover:bg-red-600 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                        Stop Recording
                    </button>
                </div>
            </div>

            <!-- Prompts & Audio -->
            <div class="bg-white rounded-lg card-shadow p-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-6 flex items-center">
                    <svg class="w-6 h-6 mr-2 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 14.142M6.343 6.343a9 9 0 000 12.728m2.829-9.9a5 5 0 000 7.072M12 12h.01"></path>
                    </svg>
                    Prompts & Audio
                </h3>
                <div class="space-y-3">
                    <button @click="getPrompts()" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                        Get Available Prompts
                    </button>
                    <div class="flex space-x-2">
                        <input x-model="promptId" type="text" placeholder="Prompt ID" class="flex-1 border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <button @click="playPrompt()" class="bg-indigo-500 hover:bg-indigo-600 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                            Play
                        </button>
                    </div>
                </div>
            </div>

            <!-- Data Management -->
            <div class="bg-white rounded-lg card-shadow p-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-6 flex items-center">
                    <svg class="w-6 h-6 mr-2 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    Data Management
                </h3>
                <div class="space-y-3">
                    <button @click="getContactFields()" class="w-full bg-emerald-500 hover:bg-emerald-600 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                        Get Contact Fields
                    </button>
                    <button @click="getDomainCAVs()" class="w-full bg-emerald-500 hover:bg-emerald-600 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                        Get Domain CAVs
                    </button>
                    <button @click="getSpeedDials()" class="w-full bg-emerald-500 hover:bg-emerald-600 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                        Get Speed Dials
                    </button>
                    <button @click="getAgentCampaigns()" class="w-full bg-emerald-500 hover:bg-emerald-600 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                        Get Agent Campaigns
                    </button>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div class="mt-8 bg-white rounded-lg card-shadow p-6">
            <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                <svg class="w-6 h-6 mr-2 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                API Results
                <button @click="clearResults()" class="ml-auto text-sm bg-gray-200 hover:bg-gray-300 text-gray-700 px-3 py-1 rounded transition-colors">
                    Clear
                </button>
            </h3>
            <div id="resultsContainer" class="result-box bg-gray-50 border border-gray-200 rounded-lg p-4">
                <p class="text-gray-500 text-sm">API results will appear here...</p>
            </div>
        </div>

        <!-- WebSocket Events Log -->
        <div class="mt-8 bg-white rounded-lg card-shadow p-6">
            <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                <svg class="w-6 h-6 mr-2 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                </svg>
                WebSocket Events
                <button @click="clearEvents()" class="ml-auto text-sm bg-gray-200 hover:bg-gray-300 text-gray-700 px-3 py-1 rounded transition-colors">
                    Clear
                </button>
            </h3>
            <div id="eventsContainer" class="result-box bg-gray-50 border border-gray-200 rounded-lg p-4">
                <p class="text-gray-500 text-sm">WebSocket events will appear here...</p>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        class f9socketEvent {
            constructor(eventName, handler, session) {
                this.eventName = eventName;
                this.handle = handler;
                this.session = session;
            }
        }

        /**
         * The constructor function for the Five9Session class.
         *
         * @class
         * @classdesc Represents a Five9 session with various helper methods for interacting with the Five9 API.
         */
        class Five9Session {
            /**
             * Creates a new Five9Session instance with default properties.
             */
            constructor() {
                // Set the Freedom Metadata URL
                this.freedomMetadataURL = "https://app.five9.com/appsvcs/rs/svc/auth/metadata";

                // Generate a random socket key
                this.randomSocketKey = (Math.random() * 1000 + 1).toString().split(".")[0];

                // Set the context paths for various API endpoints
                this.contextPaths = {
                    agent_rest: "/appsvcs/rs/svc",
                    agent_str: "/strsvcs/rs/svc",
                    sup_rest: "/supsvcs/rs/svc",
                    websocket_agent: `/appsvcs/ws/${this.randomSocketKey}_agent`,
                    websocket_super: `/supsvcs/ws/${this.randomSocketKey}_super`,
                };

                // Set the default XHR options
                this.defaultXhrOptions = {
                    credentials: "include",
                    headers: {
                        "Content-Type": "application/json",
                    },
                };

                // placeholder for updated metadata if provided by a websocket event
                this.newMetadata = null;

                // Initialize instance variables
                this.f9currentCall = null;
                this.f9currentCallId = null;
                this.f9domainContactFieldIdsByFieldName = {};
                this.DOMAIN_CAVs = {};
                this.CAVs = {};

                this.commonSocketEventHanders = {
                    1002: new f9socketEvent(
                        "EVENT_METADATA_UPDATE",
                        function (eventData) {
                            console.log(this.eventName, eventData.context.eventReason);
                            console.log(eventData);
                            this.session.newMetadata = eventData.payLoad;
                        },
                        this
                    ),
                    73: new f9socketEvent(
                        "EVENT_MIGRATION_COMPLETE",
                        async function (eventData) {
                            console.log(this.eventName, eventData.context.eventReason);
                            console.log(eventData);
                            if (this.session.newMetadata) {
                                await this.session.reinitializeWebSocket(this.session.newMetadata);
                            }
                        },
                        this
                    ),
                };
            }

            /**
             * Rebuilds the WebSocket connection using the new metadata provided by the EVENT_METADATA_UPDATE event.
             *
             * @returns {Promise} A Promise that resolves with the Freedom Metadata for the current user.
             */
            async reinitializeWebSocket(newMetadata) {
                // Update instance properties using the new metadata
                const host = newMetadata.dataCenters[0].apiUrls[0].host;
                const port = newMetadata.dataCenters[0].apiUrls[0].port;
                this.base_api_url = `https://${host}:${port}`;
                this.base_ws_url = `wss://${host}:${port}`;

                this.base_api_url_agents = `${this.base_api_url}${this.contextPaths.agent_rest}`;
                this.base_api_url_sprvsr = `${this.base_api_url}${this.contextPaths.sup_rest}`;

                this.base_websocket_api_url_agent = `${this.base_ws_url}${this.contextPaths.websocket_agent}`;
                this.base_websocket_api_url_supervisor = `${this.base_ws_url}${this.contextPaths.websocket_super}`;

                // Reconnect the WebSocket
                await this.connectAgentWebsocket();
            }

            /**
             * Connect to a WebSocket endpoint and process events using provided event handlers.
             *
             * @param {string} endpointUrl - The URL of the WebSocket endpoint to connect to.
             * @param {Object} f9socketEventHandlers - An object containing event handlers for different event IDs.
             */
            async connectSocket(endpointUrl, f9socketEventHandlers) {
                // Create a new WebSocket instance with the provided endpoint URL
                const f9Socket = new window.WebSocket(endpointUrl);
                let pingIntervalHandle = null;

                // Set up the 'onopen' event handler for the WebSocket
                f9Socket.onopen = function () {
                    // Keep the socket connection alive by sending a 'ping' message every 15 seconds
                    pingIntervalHandle = window.setInterval(function () {
                        f9Socket.send("ping");
                    }, 15000);
                    console.info("Websocket Opened");
                };

                // Attach a callback function to the "message" events on the socket
                f9Socket.addEventListener("message", function (event) {
                    // Parse the event data received from the WebSocket message
                    const eventData = JSON.parse(event.data);

                    // Log the event data if the "verbose=true" query parameter is present
                    if (window.location.search.indexOf("verbose=true") > -1) {
                        console.log(eventData.context.eventId + ": " + eventData.context.eventReason);
                        console.log(eventData);
                    }

                    // Retrieve the event handler for the specific event ID
                    let eventHandler = f9socketEventHandlers[eventData.context.eventId];
                    if (eventHandler) {
                        // Call the event handler with the event data
                        eventHandler.handle(eventData);
                    } else {
                        // Register a new 'Unhandled Socket Event' handler if no handler exists for the event ID
                        console.log(`Unhandled Socket Event Registered:\n\t${eventData.context.eventId}\n\t${JSON.stringify(eventData.payLoad)}`);
                        f9socketEventHandlers[eventData.context.eventId] = new f9socketEvent("Unhandled Socket Event", function (eventData) {
                            // console.log(this.eventName, eventData.context.eventReason)
                        });
                    }
                    console.log(eventData);
                });

                // Set up the 'onclose' event handler for the WebSocket
                f9Socket.onclose = function () {
                    // Clear the ping interval when the WebSocket connection is closed
                    window.clearInterval(pingIntervalHandle);
                };

                // Add an event listener for the 'unload' event to close the WebSocket connection when the page is unloaded
                window.addEventListener("unload", function () {
                    f9Socket.close();
                });
                return f9Socket;
            }

            /**
             * Connect to the agent WebSocket endpoint and process events using provided event handlers.
             *
             * @param {Object} f9socketEventHandlers - An object containing event handlers for different event IDs.
             */
            async connectAgentWebsocket(f9socketEventHandlers = {}) {
                // merge the common socket event handlers with the agent specific ones
                f9socketEventHandlers = Object.assign(f9socketEventHandlers, this.commonSocketEventHanders);

                return this.connectSocket(this.base_websocket_api_url_agent, f9socketEventHandlers);
            }

            /**
             * A generic asynchronous method for making API requests to the agent and supervisor REST API.
             *
             * @async
             * @function
             * @param {string} endpointURL - The URL of the API endpoint.
             * @param {string} method - The HTTP request method (e.g., "GET", "POST", "PUT", "DELETE").
             * @param {Object} [endpointOptions] - Optional configuration object for the request, such as headers.
             * @param {Object|string} [payload] - Optional request payload, if applicable.
             * @param {bool} bypassSupervisorCheck - Optional, bypass the supervisor check for supervisor methods that do not need a check.
             * @returns {Promise<Object|null>} Returns a Promise that resolves to the JSON response object or null if there was an error.
             * @throws {Error} If the response is not ok.
             */
            async f9ApiMethod(
                endpointURL,
                method,
                payload = undefined,
                endpointOptions = undefined,
                bypassSupervisorCheck = false
            ) {
                // Set default options if endpointOptions is not provided
                if (!endpointOptions) {
                    endpointOptions = { ...this.defaultXhrOptions };
                }

                // Set the request method in endpointOptions
                endpointOptions.method = method;

                // Add the payload to the request options, if provided
                if (payload) {
                    endpointOptions.body = payload;
                    // Convert the payload to a JSON string if it's an object and the Content-Type is "application/json"
                    if (
                        endpointOptions.headers["Content-Type"] == "application/json" &&
                        typeof payload == "object"
                    ) {
                        endpointOptions.body = JSON.stringify(endpointOptions.body);
                    }
                }

                try {
                    // Log the endpoint URL
                    console.log(`Endpoint URL: ${endpointURL}`);

                    // Make the request and wait for the response
                    const response = await fetch(endpointURL, endpointOptions);

                    // Throw an error if the response is not ok
                    if (!response.ok) {
                        throw new Error(`Error fetching ${endpointURL}`);
                    }

                    // Parse the response JSON
                    try {
                        const data = await response.json();
                        // Log the response data
                        console.log(`Endpoint Response Body:`);
                        console.log(data);

                        // Return the response data
                        return data;
                    } catch (error) {
                        return response;
                    }
                } catch (error) {
                    // Log the error and return null
                    console.error(error);
                    return null;
                }
            }

            /**
             * Fetch session metadata and initialize the instance properties.
             *
             * This method should be the first thing called after initializing the Five9Session object.
             * It fetches session metadata from the Five9 API, extracts the necessary data,
             * and initializes the instance properties accordingly.
             *
             * @async
             * @function
             * @returns {Promise<boolean>} Returns a Promise that resolves to true if the metadata is successfully acquired, and false otherwise.
             */
            async getSessionMetadata() {
                try {
                    // Fetch the session metadata from the Five9 API
                    const response = await fetch(this.freedomMetadataURL, {
                        credentials: "include",
                    });
                    if (!response.ok) {
                        throw new Error("Error fetching session metadata");
                    }

                    // Parse the response as JSON
                    const metadataResponse = await response.json();

                    // Set instance properties using the fetched metadata
                    this.f9OrgId = metadataResponse.orgId;
                    this.f9UserId = metadataResponse.userId;
                    this.f9TokenId = metadataResponse.tokenId;

                    const host = metadataResponse.metadata.dataCenters[0].apiUrls[0].host;
                    const port = metadataResponse.metadata.dataCenters[0].apiUrls[0].port;
                    this.base_api_url = `https://${host}:${port}`;
                    this.base_ws_url = `wss://${host}:${port}`;

                    this.base_api_url_agents = `${this.base_api_url}${this.contextPaths.agent_rest}`;
                    this.base_api_url_sprvsr = `${this.base_api_url}${this.contextPaths.sup_rest}`;

                    this.base_websocket_api_url_agent = `${this.base_ws_url}${this.contextPaths.websocket_agent}`;
                    this.base_websocket_api_url_supervisor = `${this.base_ws_url}${this.contextPaths.websocket_super}`;

                    // Log the successful acquisition of metadata
                    console.log(`Metadata successfully acquired\norgId: \t${this.f9OrgId}\nuserId: \t${this.f9UserId}\ntokenId: \t${this.f9TokenId}`);

                    // Return true to indicate successful metadata acquisition
                    return true;
                } catch (error) {
                    // Log an error message and return false to indicate failure
                    console.log("You must be logged into Five9 in another browser tab for this to work");
                    return false;
                }
            }

            /**
             * getCampaignInfo returns a CampaignInfo object, requires a campaignId.
             *
             * Five9 VCC Agent API Method:
             *   GET /orgs/{orgId}/campaigns/{campaignId}
             *
             * Five9 Response sample:
             *   {
             *       "id":"2494",
             *       "name":"Inbound Service",
             *       "campaignType":"INBOUND",
             *       "customSource":null,
             *       "customIcon":null,
             *       "assistances":[],
             *       "attributes":[],
             *       "avatarURL":null,
             *       "chatWelcomeMessage":null,
             *       "chatTerminateMessage":null,
             *       "outEmail":null,
             *       "skillIds":[],
             *       "state":"RUNNING",
             *       "flags":["PASS_CONTACTS_ANI_FOR_3RD_PARTY_CONFERENCES"]
             *   }
             *
             * Method return sample:
             *   <object campaignInfo>
             */
            async getCampaignInfo(campaignId) {
                const endpointURL = `${this.base_api_url_agents}/orgs/${this.f9OrgId}/campaigns/${campaignId}`;
                return this.f9ApiMethod(endpointURL, "GET");
            }

        /**
             * getAgentInfo returns agent information for a given userId
             * 
             * Five9 VCC Agent API Method:
             *   GET /agents/{agentId}
             */
            async getAgentInfo(userId = null) {
                const agentId = userId || this.f9UserId;
                const endpointURL = `${this.base_api_url_agents}/agents/${agentId}`;
                return this.f9ApiMethod(endpointURL, "GET");
            }

            /**
             * getAgentCampaigns returns a dictionary of campaignInfo objects the agent skills give them access to, with the campaign name as the key.
             *
             * Five9 VCC Agent API Method:
             *   GET /agents/{agentId}/campaigns_config
             *
             * Five9 Response sample:
             * ["1234", "43802", "23423"]
             *
             * method return sample:
             * {"Inbound Service": <object campaignInfo>, "Outbound Outreach": <object campaignInfo>}
             */
            async getAgentCampaigns() {
                const endpointURL = `${this.base_api_url_agents}/agents/${this.f9UserId}/campaigns_config`;
                console.log(endpointURL);
                
                const response = await this.f9ApiMethod(endpointURL, "GET");
                if (response && response.campaignIds) {
                    const agentCampaignsInfo = {};
                    
                    // Use Promise.all to get all campaign info in parallel
                    const campaignPromises = response.campaignIds.map(campaignId => 
                        this.getCampaignInfo(campaignId)
                    );
                    
                    const campaigns = await Promise.all(campaignPromises);
                    campaigns.forEach(campaign => {
                        if (campaign && campaign.name) {
                            agentCampaignsInfo[campaign.name] = campaign;
                        }
                    });
                    
                    return agentCampaignsInfo;
                }
                return response;
            }

            /**
             * callExternalNumber initiates an outbound call to a dnis and requires EITHER a campaignName OR campaignId which will be used to make the call
             *
             * Five9 VCC Agent API Method:
             *   POST /agents/{agentId}/interactions/make_external_call
             *
             * Five9 Response sample:
             *     undefined
             *     (status 200 OK)
             */
            async callExternalNumber(dnis, campaignName = null, campaignId = null) {
                if (campaignId == null && campaignName == null) {
                    console.log("callExternalNumber() requires a campaignName or campaignId");
                    return null;
                }

                const ExternalCallDestinationInfo = {
                    number: dnis,
                    campaignId: campaignId,
                };

                if (campaignId == null) {
                    const agentCampaigns = await this.getAgentCampaigns();
                    ExternalCallDestinationInfo.campaignId = agentCampaigns[campaignName].id;
                }

                if (ExternalCallDestinationInfo.campaignId == null) {
                    console.log("callExternalNumber() requires a valid campaignName or campaignId. campaignName provided: " + campaignName);
                    return null;
                }

                const endpointURL = `${this.base_api_url_agents}/agents/${this.f9UserId}/interactions/make_external_call`;
                console.log(endpointURL);
                
                return this.f9ApiMethod(endpointURL, "POST", ExternalCallDestinationInfo);
            }

            /**
             * getCurrentCalls returns an array of calls [<object CallInfo>, ] with which the agent can work
             *
             * Five9 VCC Agent API Method:
             *   GET /agents/{agentId}/interactions/calls
             *
             * Five9 Response Sample <object callInfo>:
             *   [{id: "C86EBE50B9744D6D946531842B278846", campaignId: "1137597", callType: "AGENT", transfer: false, userTransferringId: null, ...}, ...]
             */
            async getCurrentCalls() {
                const endpointURL = `${this.base_api_url_agents}/agents/${this.f9UserId}/interactions/calls`;
                console.log(endpointURL);
                const calls = await this.f9ApiMethod(endpointURL, "GET");
                if (calls && calls.length > 0) {
                    this.f9currentCall = calls[0];
                    this.f9currentCallId = calls[0].id;
                }
                return calls;
            }

            /**
             * click2dial initiates a click to dial call
             */
            async click2dial(campaignId) {
                const endpointURL = `${this.base_api_url_agents}/orgs/${this.f9OrgId}/interactions/click_to_dial?number=9133259337&dialImmediately=true&skipDNCCheck=true&campaignId=${campaignId}&autoResolveDialingRules=true&skipMultipleContactsCheck=true`;
                return this.f9ApiMethod(endpointURL, "GET");
            }


            /**
             * getDomainCallVariables returns the call attached variables for a given callID
             *
             * Five9 VCC Agent API Method:
             *   GET /orgs/{orgId}/call_variables
             */
            async getDomainCallVariables() {
                const endpointURL = `${this.base_api_url_agents}/orgs/${this.f9OrgId}/call_variables`;
                console.log(endpointURL);
                
                const cavsResponse = await this.f9ApiMethod(endpointURL, "GET");
                if (cavsResponse) {
                    const cavs = {};
                    cavsResponse.forEach((cav) => {
                        cavs[cav.group] = cavs[cav.group] || {};
                        cavs[cav.group][cav.name] = cavs[cav.group][cav.name] || {};
                        cavs[cav.group][cav.name]["id"] = cav.id;
                        cavs[cav.group][cav.name]["type"] = cav.type;
                        cavs[cav.group][cav.name]["restrictions"] = cav.restrictions;
                    });
                    console.log("Domain CAVs after transformation:");
                    console.log(cavs);
                    this.DOMAIN_CAVs = cavs;
                    return cavs;
                }
                return cavsResponse;
            }

            /**
             * setDomainCallVariable returns the call attached variables for a given callID
             *
             * Five9 VCC Agent API Method:
             *   GET /orgs/{orgId}/call_variables
             */
            async setDomainCallVariable() {
                const endpointURL = `${this.base_api_url_agents}/orgs/${this.f9OrgId}/call_variables`;
                console.log(endpointURL);
                return this.f9ApiMethod(endpointURL, "GET");
            }

            /**
             * updateCallVariableValues updates call attached variables for the current call
             *
             * Five9 VCC Agent API Method:
             *   PUT /agents/{agentId}/interactions/calls/{callId}/variables_2
             */
            async updateCallVariableValues(cavsToUpdate) {
                const currentCalls = await this.getCurrentCalls();
                if (!currentCalls || currentCalls.length === 0) {
                    console.log("No active calls found to update CAVs");
                    return null;
                }
                
                const callId = currentCalls[0].id;
                const endpointURL = `${this.base_api_url_agents}/agents/${this.f9UserId}/interactions/calls/${callId}/variables_2`;
                console.log(endpointURL);
                
                return this.f9ApiMethod(endpointURL, "PUT", cavsToUpdate);
            }

            /**
             * getContactFields returns an array of contactFields on the domain
             *
             * Five9 VCC Agent API Method:
             *   GET /orgs/{orgId}/contact_fields
             *
             * Five9 Response Sample <object domainContactFields>:
             *   [{dataType: "NUMBER", id: "114", name: "influence_score", primary: false, restrictions: {restrictions: [], limitedSetInfo: null} }, ...]
             */
            async getContactFields() {
                const endpointURL = `${this.base_api_url_agents}/orgs/${this.f9OrgId}/contact_fields`;
                console.log(endpointURL);

                const contactFields = await this.f9ApiMethod(endpointURL, "GET");
                if (contactFields) {
                    for (const fieldId in contactFields) {
                        this.f9domainContactFieldIdsByFieldName[contactFields[fieldId].name] = contactFields[fieldId];
                    }
                }
                return contactFields;
            }

            /**
             * Updates contact info. Accepts an array of fieldId and Values to update on the record.
             *
             * Five9 VCC Agent API Method:
             *   PUT /agents/{agentId}/interactions/calls/{callId}/update_contact
             */
            async updateContactInfo(fieldUpdates = [{ 1010: "TestFirstName" }]) {
                const contactFields = await this.getContactFields();
                console.log(contactFields);

                const activeCalls = await this.getCurrentCalls();
                const activeCall = activeCalls[0];
                const callId = activeCall.id;
                console.log(activeCall);

                // Process Field Updates
                for (let i = 0; i < fieldUpdates.length; i++) {
                    activeCall.activeContact.fields[fieldUpdates[i]] = "AWTEST87";
                }

                const contactInfo = activeCall.activeContact;
                console.log(contactInfo);
                const endpointURL = `${this.base_api_url_agents}/agents/${this.f9UserId}/interactions/calls/${callId}/update_contact`;

                return this.f9ApiMethod(endpointURL, "PUT", contactInfo);
            }

            /**
             * Updates contact info by field name. Accepts an object of field names and values to update on the record.
             *
             * Five9 VCC Agent API Method:
             *   PUT /orgs/{orgId}/contacts/{contactId}
             */
            async updateContactInfoByFieldName(contact, fieldUpdates) {
                const contactFields = await this.getContactFields();
                
                for (const [key, value] of Object.entries(fieldUpdates)) {
                    console.log("Updating " + key + ": " + value);
                    const fieldId = this.f9domainContactFieldIdsByFieldName[key].id;
                    contact.fields[fieldId] = value;
                }

                const endpointURL = `${this.base_api_url_agents}/orgs/${this.f9OrgId}/contacts/${contact.id}`;
                console.log(endpointURL);

                return this.f9ApiMethod(endpointURL, "PUT", contact);
            }

            /**
             * pauseCurrentCallRecording stops call recording for a given callId. If no callId is provided, the
             * user's active call is obtained from getCurrentCalls()
             *
             * Five9 VCC Agent API Method:
             *   PUT /agents/{agentId}/interactions/calls/{callId}/pause_recording
             */
            async pauseCurrentCallRecording(callId = null) {
                if (callId === null) {
                    const activeCalls = await this.getCurrentCalls();
                    callId = activeCalls[0].id;
                }

                const endpointURL = `${this.base_api_url_agents}/agents/${this.f9UserId}/interactions/calls/${callId}/pause_recording`;
                console.log(endpointURL);

                return this.f9ApiMethod(endpointURL, "PUT");
            }

            /**
             * stopCurrentCallRecording stops call recording for a given callId. If no callId is provided, the
             * user's active call is obtained from getCurrentCalls()
             *
             * Five9 VCC Agent API Method:
             *   PUT /agents/{agentId}/interactions/calls/{callId}/stop_recording
             */
            async stopCurrentCallRecording(callId = null) {
                if (callId === null) {
                    const activeCalls = await this.getCurrentCalls();
                    callId = activeCalls[0].id;
                }

                const endpointURL = `${this.base_api_url_agents}/agents/${this.f9UserId}/interactions/calls/${callId}/stop_recording`;
                console.log(endpointURL);

                return this.f9ApiMethod(endpointURL, "PUT");
            }

            /**
             * dispose Finishes a call and sets a disposition.
             *
             * Five9 VCC Agent API Method:
             *   PUT /agents/{agentId}/interactions/calls/{callId}/dispose
             */
            async disposeCurrentCall(callId = null, dispositionId, timeout = null) {
                if (callId === null) {
                    const activeCalls = await this.getCurrentCalls();
                    callId = activeCalls[0].id;
                }

                const endpointURL = `${this.base_api_url_agents}/agents/${this.f9UserId}/interactions/calls/${callId}/dispose`;
                console.log(endpointURL);
                console.log(callId);
                
                const disposeOptionsInfo = {
                    dispositionId: dispositionId,
                };

                if (timeout != null) {
                    disposeOptionsInfo.timeout = timeout;
                }

                return this.f9ApiMethod(endpointURL, "PUT", disposeOptionsInfo);
            }

            /**
             * resumeCurrentCallRecording resumes call recording for a given callId.
             *
             * Five9 VCC Agent API Method:
             *   PUT /agents/{agentId}/interactions/calls/{callId}/resume_recording
             */
            async resumeCurrentCallRecording(callId = null) {
                if (callId === null) {
                    const activeCalls = await this.getCurrentCalls();
                    callId = activeCalls[0].id;
                }

                const endpointURL = `${this.base_api_url_agents}/agents/${this.f9UserId}/interactions/calls/${callId}/resume_recording`;
                console.log(endpointURL);

                return this.f9ApiMethod(endpointURL, "PUT");
            }

            /**
             * initiateConferenceTransfer adds a DNIS to the call. Set warm=true for a warm conference (1st party on hold).
             *
             * Five9 VCC Agent API Method:
             *   POST /agents/{agentId}/interactions/calls/{callId}/add_external_to_conference
             */
            async initiateConferenceTransfer(callId, dnis, warm = false, checkDNC = true, includeCallerInfo = true) {
                const destinationInfo = {
                    number: dnis,
                    warm: warm,
                    checkDNC: checkDNC,
                    includeCallerInfo: includeCallerInfo,
                };

                const endpointURL = `${this.base_api_url_agents}/agents/${this.f9UserId}/interactions/calls/${callId}/add_external_to_conference`;
                console.log(endpointURL);

                return this.f9ApiMethod(endpointURL, "POST", destinationInfo);
            }

            /**
             * initiateTransferToExternal transfers the call to an external number. Set warm=true for a warm transfer (1st party on hold).
             *
             * Five9 VCC Agent API Method:
             *   PUT /agents/{agentId}/interactions/calls/{callId}/transfer_to_external_number
             */
            async initiateTransferToExternal(
                dnis,
                dispositionId = "-23",
                dispositionTimeout = 300000,
                timeout = 0,
                warm = false,
                skipDNCCheck = false
            ) {
                const activeCalls = await this.getCurrentCalls();
                const callId = activeCalls[0].id;

                const externalTransferDestinationInfo = {
                    destination: {
                        skipDNCCheck: skipDNCCheck,
                        checkMultipleContacts: true,
                        number: dnis,
                    },
                    warm: warm,
                    dispositionTimeout: dispositionTimeout,
                    timeout: timeout,
                };

                const endpointURL = `${this.base_api_url_agents}/agents/${this.f9UserId}/interactions/calls/${callId}/transfer_to_external_number`;
                console.log(endpointURL);

                return this.f9ApiMethod(endpointURL, "PUT", externalTransferDestinationInfo);
            }

            /**
             * addCampaignToConference adds a campaign to conference. Set warm=true for a warm transfer (1st party on hold).
             *
             * Five9 VCC Agent API Method:
             *   PUT /agents/{agentId}/interactions/calls/{callId}/add_campaign_to_conference
             */
            async addCampaignToConference(campaignId = "1140040", warm = false) {
                const activeCalls = await this.getCurrentCalls();
                const callId = activeCalls[0].id;

                const campaignInfo = {
                    campaignId: campaignId,
                    warm: warm,
                };

                const endpointURL = `${this.base_api_url_agents}/agents/${this.f9UserId}/interactions/calls/${callId}/add_campaign_to_conference`;
                console.log(endpointURL);

                return this.f9ApiMethod(endpointURL, "POST", campaignInfo);
            }

            /**
             * Returns active skills prompts information for the specified agent
             *
             * Five9 VCC Agent API Method:
             *   GET /agents/{agentId}/prompts
             */
            async getPrompts() {
                const endpointURL = `${this.base_api_url_agents}/agents/${this.f9UserId}/prompts`;
                console.log(endpointURL);
                return this.f9ApiMethod(endpointURL, "GET");
            }

            /**
             * Returns speed dials
             *
             * Five9 VCC Agent API Method:
             *   GET /orgs/{orgId}/speed_dials
             */
            async getDomainSpeedDials() {
                const endpointURL = `${this.base_api_url_agents}/orgs/${this.f9OrgId}/speed_dials`;
                console.log(endpointURL);
                return this.f9ApiMethod(endpointURL, "GET");
            }

            /**
             * get EWT for a specific skill
             *
             * Five9 VCC Agent API Method:
             *   GET /orgs/{orgId}/ewt/group/{skillGroupId}/{mediaTypeId}
             */
            async getEwtForSkill(skillGroupId, mediaTypeId = "3000") {
                const endpointURL = `${this.base_api_url_sprvsr}/orgs/${this.f9OrgId}/ewt/group/${skillGroupId}/${mediaTypeId}`;
                console.log(endpointURL);
                return this.f9ApiMethod(endpointURL, "GET");
            }

            /**
             * play_prompt plays an audio prompt on the agent interaction
             *
             * Five9 VCC Agent API Method:
             *   PUT /agents/{agentId}/interactions/calls/{callId}/audio/player/play_prompt
             */
            async playPrompt(promptId) {
                const activeCalls = await this.getCurrentCalls();
                const callId = activeCalls[0].id;

                const promptInfo = {
                    value: promptId,
                };

                const endpointURL = `${this.base_api_url_agents}/agents/${this.f9UserId}/interactions/calls/${callId}/audio/player/play_prompt`;
                console.log(endpointURL);

                return this.f9ApiMethod(endpointURL, "PUT", promptInfo);
            }

            /**
             * callRecordingView creates a Call Recording View
             *
             * Five9 VCC Agent API Method:
             *   POST /supervisors/{supervisorId}/agents/{agentId}/recording_views
             */
            async callRecordingView(limit = 300, sortField = "NAME", ascending = true, target_agentID = "") {
                const RecordingsViewOptions = {
                    limit: limit,
                    sortField: sortField.toUpperCase(),
                    ascending: "true",
                };

                const endpointURL = `${this.base_api_url_sprvsr}/supervisors/${this.f9UserId}/agents/${target_agentID}/recording_views`;
                console.log(endpointURL);

                return this.f9ApiMethod(endpointURL, "POST", RecordingsViewOptions);
            }

            /**
             * getContactById obtains contact record by ContactId
             *
             * Five9 VCC Agent API Method:
             *   GET /orgs/{orgId}/contacts/{contactId}
             */
            async getContactById(contactId) {
                const endpointURL = `${this.base_api_url_agents}/orgs/${this.f9OrgId}/contacts/${contactId}`;
                console.log("getContactById" + endpointURL);
                return this.f9ApiMethod(endpointURL, "GET");
            }

            /**
             * assignContactToCall assigns a contact record to a call
             *
             * Five9 VCC Agent API Method:
             *   PUT /agents/{agentId}/interactions/calls/{callId}/active_contact_2
             */
            async assignContactToCall(contactId) {
                const currentCalls = await this.getCurrentCalls();
                const callId = currentCalls[0].id;

                const contactInfo = {
                    value: contactId,
                };

                const endpointURL = `${this.base_api_url_agents}/agents/${this.f9UserId}/interactions/calls/${callId}/active_contact_2`;
                console.log(endpointURL);

                return this.f9ApiMethod(endpointURL, "PUT", contactInfo);
            }
        }

        // THIS is where you would build out event handlers for things that you care about
        let f9socketEventHandlers = {
            4: new f9socketEvent("EVENT_CALL_UPDATED", function (eventData) {
                console.log(this.eventName, eventData.context.eventReason);
                console.log(eventData);
                
                // Log event to the UI
                logEvent(`CALL UPDATED: ${eventData.context.eventReason}`, eventData);

                // EXAMPLE use events to stop/start recording for all calls
                // let stopRecordingReasons = ["UPDATED", "CONNECTED", "RECORDING_ALLOWED"];
                // let stopRecordingStates = ["TALKING"];

                //if(stopRecordingReasons.indexOf(eventData.context.eventReason) > -1 && stopRecordingStates.indexOf(eventData.payload.state))
            }),

            5: new f9socketEvent("EVENT_CALL_DELETED", function (eventData) {
                console.log(this.eventName, eventData.context.eventReason);
                console.log(eventData);
                logEvent(`CALL DELETED: ${eventData.context.eventReason}`, eventData);
            }),
        };

        let globalSession = null;
        let eventCounter = 0;

        // Alpine.js component for the interface
        function f9Interface() {
            return {
                promptId: '',
                
                init() {
                    console.log('Five9 Interface initialized');
                },

                async getCurrentCalls() {
                    if (!globalSession) {
                        await Swal.fire({
                            title: 'Session Error',
                            text: 'Session not initialized. Please refresh the page.',
                            icon: 'error',
                            confirmButtonText: 'OK'
                        });
                        logResult('Error: Session not initialized');
                        return;
                    }
                    try {
                        // Show loading state for longer operations
                        const loadingAlert = Swal.fire({
                            title: 'Retrieving Calls...',
                            allowOutsideClick: false,
                            didOpen: () => {
                                Swal.showLoading();
                            }
                        });

                        const calls = await globalSession.getCurrentCalls();
                        
                        // Close loading
                        Swal.close();
                        
                        // Show result with more detail
                        if (calls && calls.length > 0) {
                            await Swal.fire({
                                title: `${calls.length} Active Call${calls.length > 1 ? 's' : ''} Found`,
                                html: `
                                    <div class="text-left">
                                        ${calls.map((call, index) => `
                                            <div class="mb-2 p-2 bg-gray-50 rounded">
                                                <strong>Call ${index + 1}:</strong><br>
                                                ID: ${call.id}<br>
                                                Type: ${call.callType}<br>
                                                State: ${call.state || 'Unknown'}
                                            </div>
                                        `).join('')}
                                    </div>
                                `,
                                icon: 'info',
                                confirmButtonText: 'OK'
                            });
                        } else {
                            await Swal.fire({
                                title: 'No Active Calls',
                                text: 'No active calls found for this agent',
                                icon: 'info',
                                timer: 2000,
                                showConfirmButton: false
                            });
                        }
                        
                        logResult('Current Calls Retrieved', calls);
                    } catch (error) {
                        Swal.close();
                        await Swal.fire({
                            title: 'Error',
                            text: 'Failed to retrieve current calls',
                            icon: 'error',
                            confirmButtonText: 'OK'
                        });
                        logResult('Error getting current calls', error);
                    }
                },

                async makeExternalCall() {
                    if (!globalSession) {
                        logResult('Error: Session not initialized');
                        return;
                    }
                    
                    try {
                        // Get DNIS input
                        const { value: dnis } = await Swal.fire({
                            title: 'Make External Call',
                            input: 'tel',
                            inputLabel: 'Enter DNIS to dial:',
                            inputPlaceholder: 'e.g., +1234567890',
                            showCancelButton: true,
                            confirmButtonText: 'Next',
                            cancelButtonText: 'Cancel',
                            inputValidator: (value) => {
                                if (!value) {
                                    return 'Please enter a valid phone number';
                                }
                            }
                        });

                        if (!dnis) return; // User cancelled

                        // Get campaign name input
                        const { value: campaignName } = await Swal.fire({
                            title: 'Campaign Selection',
                            input: 'text',
                            inputLabel: 'Enter campaign name:',
                            inputValue: 'DEFAULT_CAMPAIGN',
                            showCancelButton: true,
                            confirmButtonText: 'Make Call',
                            cancelButtonText: 'Cancel',
                            inputValidator: (value) => {
                                if (!value) {
                                    return 'Please enter a campaign name';
                                }
                            }
                        });

                        if (!campaignName) return; // User cancelled

                        // Show loading state
                        Swal.fire({
                            title: 'Making Call...',
                            text: `Dialing ${dnis} using campaign ${campaignName}`,
                            allowOutsideClick: false,
                            didOpen: () => {
                                Swal.showLoading();
                            }
                        });

                        const result = await globalSession.callExternalNumber(dnis, campaignName);
                        
                        // Close loading and show result
                        Swal.close();
                        
                        if (result) {
                            await Swal.fire({
                                title: 'Call Initiated!',
                                text: `Successfully initiated call to ${dnis}`,
                                icon: 'success',
                                confirmButtonText: 'OK'
                            });
                        } else {
                            await Swal.fire({
                                title: 'Call Failed',
                                text: 'Failed to initiate external call. Check console for details.',
                                icon: 'error',
                                confirmButtonText: 'OK'
                            });
                        }
                        
                        logResult('External Call Initiated', { dnis, campaignName, result });
                    } catch (error) {
                        Swal.close();
                        await Swal.fire({
                            title: 'Error',
                            text: 'An error occurred while making the call',
                            icon: 'error',
                            confirmButtonText: 'OK'
                        });
                        logResult('Error making external call', error);
                    }
                },

                async initiateConference() {
                    if (!globalSession) {
                        logResult('Error: Session not initialized');
                        return;
                    }
                    
                    try {
                        // Get DNIS input for conference
                        const { value: dnis } = await Swal.fire({
                            title: 'Initiate Conference',
                            input: 'tel',
                            inputLabel: 'Enter DNIS for conference:',
                            inputPlaceholder: 'e.g., +1234567890',
                            showCancelButton: true,
                            confirmButtonText: 'Next',
                            cancelButtonText: 'Cancel',
                            inputValidator: (value) => {
                                if (!value) {
                                    return 'Please enter a valid phone number';
                                }
                            }
                        });

                        if (!dnis) return; // User cancelled

                        // Get warm transfer option
                        const result = await Swal.fire({
                            title: 'Transfer Type',
                            text: 'Would you like to make this a warm transfer?',
                            icon: 'question',
                            showCancelButton: true,
                            confirmButtonText: 'Yes, Warm Transfer',
                            cancelButtonText: 'No, Cold Transfer',
                            reverseButtons: true
                        });

                        if (result.dismiss === Swal.DismissReason.cancel) {
                            // User chose "No, Cold Transfer" - this is still a valid choice
                        } else if (!result.isConfirmed) {
                            return; // User cancelled entirely
                        }

                        const warm = result.isConfirmed;

                        // Show loading state
                        Swal.fire({
                            title: 'Initiating Conference...',
                            text: `Adding ${dnis} to conference (${warm ? 'Warm' : 'Cold'} transfer)`,
                            allowOutsideClick: false,
                            didOpen: () => {
                                Swal.showLoading();
                            }
                        });

                        const calls = await globalSession.getCurrentCalls();
                        if (calls && calls.length > 0) {
                            const conferenceResult = await globalSession.initiateConferenceTransfer(calls[0].id, dnis, warm);
                            
                            // Close loading and show result
                            Swal.close();
                            
                            if (conferenceResult) {
                                await Swal.fire({
                                    title: 'Conference Initiated!',
                                    text: `Successfully added ${dnis} to conference`,
                                    icon: 'success',
                                    confirmButtonText: 'OK'
                                });
                            } else {
                                await Swal.fire({
                                    title: 'Conference Failed',
                                    text: 'Failed to initiate conference. Check console for details.',
                                    icon: 'error',
                                    confirmButtonText: 'OK'
                                });
                            }
                            
                            logResult('Conference Transfer Initiated', { dnis, warm, result: conferenceResult });
                        } else {
                            Swal.close();
                            await Swal.fire({
                                title: 'No Active Calls',
                                text: 'No active calls found for conference transfer',
                                icon: 'warning',
                                confirmButtonText: 'OK'
                            });
                            logResult('No active calls found for conference transfer');
                        }
                    } catch (error) {
                        Swal.close();
                        await Swal.fire({
                            title: 'Error',
                            text: 'An error occurred while initiating conference',
                            icon: 'error',
                            confirmButtonText: 'OK'
                        });
                        logResult('Error initiating conference', error);
                    }
                },

                async disposeCall() {
                    if (!globalSession) {
                        logResult('Error: Session not initialized');
                        return;
                    }
                    
                    try {
                        // Get disposition ID input
                        const { value: dispositionId } = await Swal.fire({
                            title: 'Dispose Call',
                            input: 'text',
                            inputLabel: 'Enter disposition ID:',
                            inputValue: '1130796',
                            showCancelButton: true,
                            confirmButtonText: 'Dispose Call',
                            cancelButtonText: 'Cancel',
                            inputValidator: (value) => {
                                if (!value) {
                                    return 'Please enter a disposition ID';
                                }
                                if (!/^\d+$/.test(value)) {
                                    return 'Disposition ID should be numeric';
                                }
                            }
                        });

                        if (!dispositionId) return; // User cancelled

                        // Show confirmation
                        const confirmation = await Swal.fire({
                            title: 'Confirm Call Disposition',
                            text: `Are you sure you want to dispose the call with disposition ID: ${dispositionId}?`,
                            icon: 'warning',
                            showCancelButton: true,
                            confirmButtonText: 'Yes, Dispose Call',
                            cancelButtonText: 'Cancel',
                            confirmButtonColor: '#d33'
                        });

                        if (!confirmation.isConfirmed) return;

                        // Show loading state
                        Swal.fire({
                            title: 'Disposing Call...',
                            text: 'Please wait while the call is being disposed',
                            allowOutsideClick: false,
                            didOpen: () => {
                                Swal.showLoading();
                            }
                        });

                        const result = await globalSession.disposeCurrentCall(null, dispositionId);
                        
                        // Close loading and show result
                        Swal.close();
                        
                        if (result) {
                            await Swal.fire({
                                title: 'Call Disposed!',
                                text: `Successfully disposed call with disposition ID: ${dispositionId}`,
                                icon: 'success',
                                confirmButtonText: 'OK'
                            });
                        } else {
                            await Swal.fire({
                                title: 'Disposition Failed',
                                text: 'Failed to dispose call. Check console for details.',
                                icon: 'error',
                                confirmButtonText: 'OK'
                            });
                        }
                        
                        logResult('Call Disposed', { dispositionId, result });
                    } catch (error) {
                        Swal.close();
                        await Swal.fire({
                            title: 'Error',
                            text: 'An error occurred while disposing the call',
                            icon: 'error',
                            confirmButtonText: 'OK'
                        });
                        logResult('Error disposing call', error);
                    }
                },

                async pauseRecording() {
                    if (!globalSession) {
                        logResult('Error: Session not initialized');
                        return;
                    }
                    try {
                        // Show loading state
                        Swal.fire({
                            title: 'Pausing Recording...',
                            allowOutsideClick: false,
                            didOpen: () => {
                                Swal.showLoading();
                            }
                        });

                        const result = await globalSession.pauseCurrentCallRecording();
                        
                        // Close loading and show result
                        Swal.close();
                        
                        if (result !== null) {
                            await Swal.fire({
                                title: 'Recording Paused!',
                                text: 'Call recording has been successfully paused',
                                icon: 'success',
                                timer: 2000,
                                showConfirmButton: false
                            });
                        } else {
                            await Swal.fire({
                                title: 'Pause Failed',
                                text: 'Failed to pause recording. Check console for details.',
                                icon: 'error',
                                confirmButtonText: 'OK'
                            });
                        }
                        
                        logResult('Recording Paused', result);
                    } catch (error) {
                        Swal.close();
                        await Swal.fire({
                            title: 'Error',
                            text: 'An error occurred while pausing recording',
                            icon: 'error',
                            confirmButtonText: 'OK'
                        });
                        logResult('Error pausing recording', error);
                    }
                },

                async resumeRecording() {
                    if (!globalSession) {
                        logResult('Error: Session not initialized');
                        return;
                    }
                    try {
                        // Show loading state
                        Swal.fire({
                            title: 'Resuming Recording...',
                            allowOutsideClick: false,
                            didOpen: () => {
                                Swal.showLoading();
                            }
                        });

                        const result = await globalSession.resumeCurrentCallRecording();
                        
                        // Close loading and show result
                        Swal.close();
                        
                        if (result !== null) {
                            await Swal.fire({
                                title: 'Recording Resumed!',
                                text: 'Call recording has been successfully resumed',
                                icon: 'success',
                                timer: 2000,
                                showConfirmButton: false
                            });
                        } else {
                            await Swal.fire({
                                title: 'Resume Failed',
                                text: 'Failed to resume recording. Check console for details.',
                                icon: 'error',
                                confirmButtonText: 'OK'
                            });
                        }
                        
                        logResult('Recording Resumed', result);
                    } catch (error) {
                        Swal.close();
                        await Swal.fire({
                            title: 'Error',
                            text: 'An error occurred while resuming recording',
                            icon: 'error',
                            confirmButtonText: 'OK'
                        });
                        logResult('Error resuming recording', error);
                    }
                },

                async stopRecording() {
                    if (!globalSession) {
                        logResult('Error: Session not initialized');
                        return;
                    }
                    try {
                        // Show confirmation first
                        const confirmation = await Swal.fire({
                            title: 'Stop Recording?',
                            text: 'Are you sure you want to stop the call recording? This action cannot be undone.',
                            icon: 'warning',
                            showCancelButton: true,
                            confirmButtonText: 'Yes, Stop Recording',
                            cancelButtonText: 'Cancel',
                            confirmButtonColor: '#d33'
                        });

                        if (!confirmation.isConfirmed) return;

                        // Show loading state
                        Swal.fire({
                            title: 'Stopping Recording...',
                            allowOutsideClick: false,
                            didOpen: () => {
                                Swal.showLoading();
                            }
                        });

                        const result = await globalSession.stopCurrentCallRecording();
                        
                        // Close loading and show result
                        Swal.close();
                        
                        if (result !== null) {
                            await Swal.fire({
                                title: 'Recording Stopped!',
                                text: 'Call recording has been permanently stopped',
                                icon: 'success',
                                confirmButtonText: 'OK'
                            });
                        } else {
                            await Swal.fire({
                                title: 'Stop Failed',
                                text: 'Failed to stop recording. Check console for details.',
                                icon: 'error',
                                confirmButtonText: 'OK'
                            });
                        }
                        
                        logResult('Recording Stopped', result);
                    } catch (error) {
                        Swal.close();
                        await Swal.fire({
                            title: 'Error',
                            text: 'An error occurred while stopping recording',
                            icon: 'error',
                            confirmButtonText: 'OK'
                        });
                        logResult('Error stopping recording', error);
                    }
                },

                async getPrompts() {
                    if (!globalSession) {
                        logResult('Error: Session not initialized');
                        return;
                    }
                    try {
                        const prompts = await globalSession.getPrompts();
                        logResult('Available Prompts', prompts);
                    } catch (error) {
                        logResult('Error getting prompts', error);
                    }
                },

                async playPrompt() {
                    if (!globalSession) {
                        logResult('Error: Session not initialized');
                        return;
                    }
                    
                    try {
                        let promptId = this.promptId;
                        
                        // If no prompt ID is set, ask user to input one
                        if (!promptId) {
                            const { value: inputPromptId } = await Swal.fire({
                                title: 'Play Prompt',
                                input: 'text',
                                inputLabel: 'Enter prompt ID to play:',
                                inputPlaceholder: 'e.g., 1234567',
                                showCancelButton: true,
                                confirmButtonText: 'Play Prompt',
                                cancelButtonText: 'Cancel',
                                inputValidator: (value) => {
                                    if (!value) {
                                        return 'Please enter a prompt ID';
                                    }
                                    if (!/^\d+$/.test(value)) {
                                        return 'Prompt ID should be numeric';
                                    }
                                }
                            });

                            if (!inputPromptId) return; // User cancelled
                            promptId = inputPromptId;
                        }

                        // Show loading state
                        Swal.fire({
                            title: 'Playing Prompt...',
                            text: `Playing prompt ID: ${promptId}`,
                            allowOutsideClick: false,
                            didOpen: () => {
                                Swal.showLoading();
                            }
                        });

                        const result = await globalSession.playPrompt(promptId);
                        
                        // Close loading and show result
                        Swal.close();
                        
                        if (result) {
                            await Swal.fire({
                                title: 'Prompt Playing!',
                                text: `Successfully started playing prompt ID: ${promptId}`,
                                icon: 'success',
                                confirmButtonText: 'OK'
                            });
                        } else {
                            await Swal.fire({
                                title: 'Prompt Failed',
                                text: 'Failed to play prompt. Check console for details.',
                                icon: 'error',
                                confirmButtonText: 'OK'
                            });
                        }
                        
                        logResult('Prompt Played', { promptId, result });
                    } catch (error) {
                        Swal.close();
                        await Swal.fire({
                            title: 'Error',
                            text: 'An error occurred while playing the prompt',
                            icon: 'error',
                            confirmButtonText: 'OK'
                        });
                        logResult('Error playing prompt', error);
                    }
                },

                async getContactFields() {
                    if (!globalSession) {
                        logResult('Error: Session not initialized');
                        return;
                    }
                    try {
                        const fields = await globalSession.getContactFields();
                        logResult('Contact Fields', fields);
                    } catch (error) {
                        logResult('Error getting contact fields', error);
                    }
                },

                async getDomainCAVs() {
                    if (!globalSession) {
                        logResult('Error: Session not initialized');
                        return;
                    }
                    try {
                        const cavs = await globalSession.getDomainCallVariables();
                        logResult('Domain Call Variables', cavs);
                    } catch (error) {
                        logResult('Error getting domain CAVs', error);
                    }
                },

                async getSpeedDials() {
                    if (!globalSession) {
                        logResult('Error: Session not initialized');
                        return;
                    }
                    try {
                        const speedDials = await globalSession.getDomainSpeedDials();
                        logResult('Domain Speed Dials', speedDials);
                    } catch (error) {
                        logResult('Error getting speed dials', error);
                    }
                },

                async getAgentCampaigns() {
                    if (!globalSession) {
                        logResult('Error: Session not initialized');
                        return;
                    }
                    try {
                        const campaigns = await globalSession.getAgentCampaigns();
                        logResult('Agent Campaigns', campaigns);
                    } catch (error) {
                        logResult('Error getting agent campaigns', error);
                    }
                },

                clearResults() {
                    const container = document.getElementById('resultsContainer');
                    container.innerHTML = '<p class="text-gray-500 text-sm">API results will appear here...</p>';
                },

                clearEvents() {
                    const container = document.getElementById('eventsContainer');
                    container.innerHTML = '<p class="text-gray-500 text-sm">WebSocket events will appear here...</p>';
                    eventCounter = 0;
                    document.getElementById('eventCount').textContent = '0 events received';
                }
            }
        }

        // Utility functions for logging
        function logResult(title, data = null) {
            const container = document.getElementById('resultsContainer');
            const timestamp = new Date().toLocaleTimeString();
            
            const resultDiv = document.createElement('div');
            resultDiv.className = 'mb-4 p-3 bg-white border border-gray-200 rounded-lg';
            
            let content = `
                <div class="flex justify-between items-start mb-2">
                    <h4 class="font-medium text-gray-800">${title}</h4>
                    <span class="text-xs text-gray-500">${timestamp}</span>
                </div>
            `;
            
            if (data) {
                content += `<pre class="text-xs text-gray-600 bg-gray-50 p-2 rounded overflow-x-auto">${JSON.stringify(data, null, 2)}</pre>`;
            }
            
            resultDiv.innerHTML = content;
            
            // Clear placeholder if it exists
            if (container.children.length === 1 && container.children[0].textContent.includes('API results will appear here')) {
                container.innerHTML = '';
            }
            
            container.insertBefore(resultDiv, container.firstChild);
            
            // Limit to 10 results
            while (container.children.length > 10) {
                container.removeChild(container.lastChild);
            }
        }

        function logEvent(title, data = null) {
            const container = document.getElementById('eventsContainer');
            const timestamp = new Date().toLocaleTimeString();
            
            eventCounter++;
            document.getElementById('eventCount').textContent = `${eventCounter} events received`;
            
            const eventDiv = document.createElement('div');
            eventDiv.className = 'mb-4 p-3 bg-white border border-blue-200 rounded-lg';
            
            let content = `
                <div class="flex justify-between items-start mb-2">
                    <h4 class="font-medium text-blue-800">${title}</h4>
                    <span class="text-xs text-gray-500">${timestamp}</span>
                </div>
            `;
            
            if (data) {
                content += `<pre class="text-xs text-gray-600 bg-blue-50 p-2 rounded overflow-x-auto">${JSON.stringify(data, null, 2)}</pre>`;
            }
            
            eventDiv.innerHTML = content;
            
            // Clear placeholder if it exists
            if (container.children.length === 1 && container.children[0].textContent.includes('WebSocket events will appear here')) {
                container.innerHTML = '';
            }
            
            container.insertBefore(eventDiv, container.firstChild);
            
            // Limit to 10 events
            while (container.children.length > 10) {
                container.removeChild(container.lastChild);
            }
        }

        function updateConnectionStatus(status, message) {
            const indicator = document.getElementById('statusIndicator');
            const text = document.getElementById('statusText');
            
            switch(status) {
                case 'connected':
                    indicator.className = 'w-3 h-3 bg-green-400 rounded-full';
                    break;
                case 'connecting':
                    indicator.className = 'w-3 h-3 bg-yellow-400 rounded-full pulse-dot';
                    break;
                case 'error':
                    indicator.className = 'w-3 h-3 bg-red-400 rounded-full pulse-dot';
                    break;
            }
            
            text.textContent = message;
        }

        function onDocumentReady(fn) {
            if (document.readyState !== "loading") {
                fn();
            } else {
                document.addEventListener("DOMContentLoaded", fn);
            }
        }

        // Configure SweetAlert2 defaults
        function configureSweetAlert() {
            if (typeof Swal !== 'undefined') {
                Swal.mixin({
                    customClass: {
                        popup: 'swal2-popup',
                        title: 'swal2-title',
                        content: 'swal2-content',
                        confirmButton: 'swal2-confirm',
                        cancelButton: 'swal2-cancel',
                        input: 'swal2-input'
                    },
                    buttonsStyling: false,
                    allowEscapeKey: true,
                    allowOutsideClick: false,
                    showCloseButton: true
                });
            }
        }

        // Utility function for consistent error handling
        async function showApiError(title, error) {
            console.error(`${title}:`, error);
            await Swal.fire({
                title: title,
                text: typeof error === 'string' ? error : 'An unexpected error occurred. Check console for details.',
                icon: 'error',
                confirmButtonText: 'OK'
            });
        }

        // Utility function for consistent success messages
        async function showApiSuccess(title, message, autoClose = false) {
            const options = {
                title: title,
                text: message,
                icon: 'success',
                confirmButtonText: 'OK'
            };
            
            if (autoClose) {
                options.timer = 2000;
                options.showConfirmButton = false;
            }
            
            await Swal.fire(options);
        }

        onDocumentReady(async function () {
            // Configure SweetAlert2
            configureSweetAlert();
            
            updateConnectionStatus('connecting', 'Initializing session...');
            
            const session = new Five9Session();
            const metadataObtained = await session.getSessionMetadata();
            
            if (metadataObtained === true) {
                globalSession = session;
                
                // Update UI with session info
                document.getElementById('userIdDisplay').textContent = session.f9UserId;
                document.getElementById('orgIdDisplay').textContent = session.f9OrgId;
                
                updateConnectionStatus('connecting', 'Connecting to WebSocket...');
                
                // Connect to websocket with custom event handlers
                const agentWebSocket = await session.connectAgentWebsocket(f9socketEventHandlers);
                
                // Get current calls to initialize session state
                const currentCalls = await session.getCurrentCalls();
                
                updateConnectionStatus('connected', 'Connected & Ready');
                
                logResult('Five9 Session Initialized', {
                    userId: session.f9UserId,
                    orgId: session.f9OrgId,
                    currentCalls: currentCalls?.length || 0
                });
                
                console.info("Five9 Session initialized successfully");
            } else {
                updateConnectionStatus('error', 'Failed to connect');
                logResult('Session Initialization Failed', 'You must be logged into Five9 in another browser tab for this to work');
                console.log("You must be logged into Five9 in another browser tab for this to work");
            }
        });
    </script>
</body>

</html>